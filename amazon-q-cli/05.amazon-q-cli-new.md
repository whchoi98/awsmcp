# 05.Amazon Q CLI 고급 기능 (NEW)

## 🚀 AWS Q CLI 고급 기능

이번 실습에서는 지금까지 배운 Amazon Q CLI의 기능을 바탕으로, 보다 고급 기능 및 확장된 활용 방식에 대해 다룹니다.

### 🧩 Custom Agent (커스텀 에이전트)

커스텀 에이전트는 서로 다른 작업 환경에 맞춰 구성(configuration) 및 지원 리소스(supporting resources)들을 묶어

Amazon Q CLI 세션을 최적화할 수 있도록 해주는 기능입니다.

#### 📦 예시: 서로 다른 개발 작업에 맞춘 에이전트 구성

예를 들어, 다음과 같은 다양한 작업을 수행한다고 가정해봅니다:

* 프론트엔드(Front-end) 개발
* 백엔드(Back-end) 개발
* DevOps 작업

각 작업 유형마다 필요한:

* 코드
* 문서
* 이미지
* Tool (예: Model Context Protocol, MCP — 뒤에서 다룸)



이 서로 다를 수 있습니다.

이를 잘 정리해두면, 컨텍스트 설계(Context Engineering) 관점에서도 매우 효율적인 세션 구성이 가능해집니다.

#### 🧬 이전 방식: Profiles

Amazon Q CLI의 이전 버전에서는 이를 Profiles(프로파일)로 정의했습니다.

이 방식도 유용했지만, 몇 가지 제약 사항(limitations)이 있었습니다.

#### ✅ Custom Agents의 개선점

Custom Agents는 이러한 프로파일 방식의 단점을 보완하며,

다음과 같은 방식으로 작업을 간소화해줍니다:

* 작업에 필요한 리소스(resources)와 도구(tools)를 하나의 에이전트에 구성
* 각 도구에 대해 권한 설정(permissions) 가능
* 구성된 에이전트를 공유 가능, 협업에 용이
* 각 작업 유형에 맞게 최소한의 컨텍스트만 로딩하여 효율 극대화

#### 📚 더 알아보기 - Custom Agents의 활용 사례(use cases)에 대해 더 알고 싶다면, 공식 문서의 [“Benefits of using custom agents”](https://docs.aws.amazon.com/amazonq/latest/qdeveloper-ug/command-line-custom-agents-overview.html?trk=fd6bb27a-13b0-4286-8269-c7b1cfaa29f0\&sc_channel=el#custom-agent-benefits) 섹션을 참고해보세요.

✅ 요약:

Custom Agents는 Amazon Q CLI에서 작업별로 최적화된 구성 세트를 만들고 관리할 수 있는 고급 기능이며, Context Engineering의 핵심 도구 중 하나입니다.

***

### 🧩 MCP (Model Context Protocol)

MCP(Model Context Protocol)는 AI 애플리케이션을 다양한 도구(Tools) 및 데이터 소스(Data Sources)에 표준 방식으로 연결할 수 있도록 해주는 프로토콜입니다.

비유하자면, MCP는 AI 애플리케이션의 USB-C 포트와 같습니다. USB-C가 다양한 기기와 액세서리를 일관된 방식으로 연결하듯, MCP는 AI 앱과 외부 도구/데이터 소스를 연결하는 표준 인터페이스를 제공합니다.

#### 🧱 핵심 구성 요소

MCP는 Client-Server 아키텍처를 따르며, 3가지 주요 구성 요소로 이루어집니다:

<table data-header-hidden><thead><tr><th width="158.61248779296875"></th><th></th></tr></thead><tbody><tr><td>구성 요소</td><td>설명</td></tr><tr><td>MCP Host</td><td>AI 애플리케이션 자체 (예: Amazon Q CLI)  AI 모델과 상호작용 환경을 제공하며, MCP Client를 실행</td></tr><tr><td>MCP Client</td><td>Host 내에서 실행되며, MCP Server와의 통신을 담당</td></tr><tr><td>MCP Server</td><td>도구 또는 데이터 소스를 노출하는 컴포넌트  외부 기능을 제공하며, MCP Tool들을 포함함</td></tr></tbody></table>

#### 🔁 동작 흐름 (참조: 첨부된 다이어그램)

1. 사용자(User)가 Amazon Q CLI에 쿼리(query)를 입력
2. 쿼리는 프롬프트(prompt)로 변환되어 LLM으로 전달
3. 추가 컨텍스트가 필요할 경우, Amazon Q CLI는 MCP Tool을 호출
4. MCP Client가 MCP Server의 MCP Tool에 call 전송
5. MCP Tool은 데이터 소스(Data Source)에 query 수행
6. 결과를 response로 수신
7. MCP Tool은 결과를 MCP Client로 반환
8. 결과는 Amazon Q CLI로 전달
9. Amazon Q CLI는 이를 바탕으로 최종 응답(final response) 생성
10. 사용자에게 결과를 반환

<figure><img src="../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

***

#### 🖥️ 로컬 실행 vs 컨테이너 실행

> ❓ “MCP Server는 항상 원격 서버인가?” → 아니요. 대부분의 MCP Server는 \*\*로컬 프로세스(local process)\*\*로 실행됩니다.

**✅ 로컬 실행 방법:**

1. Native 실행:
   * 직접 라이브러리 또는 실행 파일 설치 후 실행
   * 빠르고 간편하지만 의존성 충돌 위험 존재
2. 컨테이너(Container) 실행:
   * Docker와 같은 환경에서 격리된 상태로 실행
   * 보안 격리, 의존성 충돌 방지, 재현성 높은 환경 보장

👉 실무에서는 컨테이너 기반 실행이 점점 더 선호되는 방식입니다.

#### 🔐 보안 주의 사항 (Security Alert ⚠️)

MCP는 실행 가능한 외부 도구를 환경 내에서 직접 실행하므로, 보안 리스크(attack surface)가 생깁니다.

안전하게 MCP를 사용하는 방법:

* 신뢰할 수 있는 출처의 서버만 설치
* 도구 설명 및 주석(annotation)을 리뷰하고 승인할 것
* 민감한 설정은 환경 변수(environment variables)를 사용할 것
* MCP Server 및 Amazon Q CLI는 항상 최신 버전으로 유지
* 로그를 모니터링하여 비정상적 활동을 감시

#### 🔒 Amazon Q CLI의 MCP 보안 모델 원칙

<table data-header-hidden><thead><tr><th width="255.73748779296875"></th><th></th></tr></thead><tbody><tr><td>원칙</td><td>설명</td></tr><tr><td>Explicit Permission (명시적 승인)</td><td>도구는 실행 전 사용자의 명시적 승인을 받아야 함</td></tr><tr><td>Local Execution (로컬 실행)</td><td>MCP 서버는 로컬에서만 실행됨</td></tr><tr><td>Isolation (격리)</td><td>각 MCP 서버는 별도 프로세스로 독립 실행</td></tr><tr><td>Transparency (투명성)</td><td>어떤 도구가 사용 가능하고, 어떤 기능을 수행하는지 사용자가 모두 확인 가능</td></tr></tbody></table>

***

### 🧩  Custom Agent 생성 &#x20;

#### 🔍 Custom Agents란?

Custom Agent(커스텀 에이전트)는 Amazon Q CLI의 동작 방식을 특정 목적(use case)에 맞게 맞춤 설정할 수 있도록 해주는 기능입니다.&#x20;

각 커스텀 에이전트는 JSON 구성 파일(configuration file)로 정의되며, 다음과 같은 항목들을 포함할 수 있습니다:

* 사용할 도구(tools) 목록
* 도구에 대한 권한 설정(permissions)
* 사용할 컨텍스트(context) 정보 (예: 마크다운 문서) 등

#### 🌍 Global vs Project Custom Agents

커스텀 에이전트는 전역(Global) 또는 프로젝트(Local) 범위로 생성할 수 있습니다:

<table data-header-hidden><thead><tr><th width="241.5374755859375"></th><th></th><th></th></tr></thead><tbody><tr><td>유형</td><td>설명</td><td>경로</td></tr><tr><td>Global Custom Agent</td><td>모든 디렉터리 및 프로젝트에서 사용 가능</td><td>~/.aws/amazonq/cli-agents/{agent-name}.json</td></tr><tr><td>Project-level Custom Agent</td><td>특정 프로젝트 디렉터리 및 하위 디렉터리에서만 사용 가능</td><td>./.amazonq/cli-agents/{agent-name}.json</td></tr></tbody></table>

📌 Git 등을 통해 프로젝트를 공유할 경우, Project Custom Agent를 사용하면 다른 개발자도 동일한 구성을 사용할 수 있습니다.

#### 🔄 에이전트 우선순위 (Precedence)

1. 현재 디렉터리에서 로컬 커스텀 에이전트 확인
2. 없다면 글로벌 커스텀 에이전트 확인
3. 둘 다 없으면 기본 에이전트(q\_cli\_default) 사용\


⚠️ 주의:

이름이 동일한 로컬/글로벌 에이전트가 존재할 경우, 로컬 에이전트가 우선됩니다.

이 경우 다음과 같은 경고 메시지가 출력됩니다:

```
WARNING: Agent conflict for my-agent. Using workspace version.
```

#### ⚙️ 기본 에이전트 확인

기본적으로 Amazon Q CLI는 `q_cli_default` 라는 내장 에이전트를 사용합니다.

아래 명령으로 현재 사용 가능한 모든 에이전트를 확인할 수 있습니다:

```
/agent list
```

출력 예시:

```
* q_cli_default
  python-developer
```

#### `/agent` :  명령어 옵션 확인

모든 agent 관련 명령은 /agent 명령어로 관리합니다:

```
/agent help
```

<table data-header-hidden><thead><tr><th width="151.9781494140625"></th><th></th></tr></thead><tbody><tr><td>명령어</td><td>설명</td></tr><tr><td>list</td><td>사용 가능한 모든 에이전트 나열</td></tr><tr><td>create</td><td>새 에이전트 생성</td></tr><tr><td>edit</td><td>기존 에이전트 수정</td></tr><tr><td>generate</td><td>AI를 활용하여 에이전트 생성</td></tr><tr><td>schema</td><td>에이전트 JSON 구성 스키마 확인</td></tr><tr><td>set-default</td><td>기본 에이전트 설정</td></tr><tr><td>swap</td><td>세션 중 다른 에이전트로 전환</td></tr></tbody></table>

#### **✅** Agent Schema

```
/agent schema
```

위 명령으로 에이전트 구성 스키마(JSON Schema)를 확인할 수 있습니다.

그러나 처음에는 모든 항목을 다 정의할 필요는 없으며, 점진적으로 확장해나가는 것이 좋습니다.

#### 🎛️ 주요 JSON 설정 항목 요약

<table data-header-hidden><thead><tr><th width="177.981201171875"></th><th></th></tr></thead><tbody><tr><td>항목</td><td>설명</td></tr><tr><td>name</td><td>(필수) 에이전트 이름</td></tr><tr><td>description</td><td>설명 (선택)</td></tr><tr><td>prompt</td><td>시스템 프롬프트처럼 고수준 지시사항 설정 (선택)</td></tr><tr><td>mcpServers</td><td>MCP 서버 연결 정보 (선택)</td></tr><tr><td>tools</td><td>사용할 도구 정의 (예: "*"는 전체 허용)</td></tr><tr><td>toolAliases</td><td>MCP 서버 간 도구 이름 충돌 방지 설정</td></tr><tr><td>allowedTools</td><td>신뢰된 도구 설정</td></tr><tr><td>resources</td><td>컨텍스트 리소스 지정 (예: file://.amazonq/rules/**/*.md)</td></tr><tr><td>hooks</td><td>세션 시작 또는 프롬프트마다 실행할 명령</td></tr><tr><td>toolsSettings</td><td>도구에 필요한 설정 전달</td></tr><tr><td>model</td><td>사용할 모델 지정 (claude-3.5-sonnet 등)</td></tr></tbody></table>

#### 🧪 Task-02: 커스텀 에이전트 생성하기

```
/agent create --name python-developer
```

위 명령을 입력하면 에디터가 열림

초기 상태 예시:

```
{
  "name": "python-developer",
  "tools": ["*"],
  "allowedTools": ["fs_read"],
  "resources": [
    "file://AmazonQ.md",
    "file://README.md",
    "file://.amazonq/rules/**/*.md"
  ]
}
```

이 구성을 다음과 같이 수정:

```
{
  "name": "python-developer",
  "prompt": null,
  "mcpServers": {},
  "tools": [],
  "toolAliases": {},
  "allowedTools": [],
  "resources": [
    "file://.amazonq/rules/**/*.md"
  ],
  "hooks": {},
  "toolsSettings": {}
}
```

저장 및 종료 (:wq!)

#### ✅ 생성 확인

```
/agent list
```

#### ✏️ 수정하기

```
/agent edit --name python-developer
```

#### 📁 프로젝트 구조 예시

```
.project-root/
├── .amazonq/
│   ├── cli-agents/
│   │   └── python-developer.json
│   └── rules/
│       └── python-dev.md
```

#### 🚀 에이전트 적용하여 실행

```
q chat --agent python-developer
```

프롬프트가 다음처럼 변경됨:

```
[python-developer] >
```

현재 로드된 컨텍스트 확인:

```
/context show
```

예시 출력:

```
[python-developer] > /context show

👤 Agent (python-developer):
    .amazonq/rules/**/*.md (1 match)
```

#### 🤖 /agent generate 명령어로 자동 생성하기 (v1.15+)

```
/agent generate
```

질문에 따라 입력:

```
✔ Enter agent name: python-dev
✔ Enter agent description: Python developer
✔ Agent scope: Local (current workspace)
```

자동 생성된 구성 예시:

```
{
  "name": "python-dev",
  "description": "Python developer",
  "prompt": "You are a Python developer assistant. ...",
  "tools": ["*"],
  "allowedTools": ["fs_read"],
  "resources": [
    "file://AmazonQ.md",
    "file://README.md",
    "file://.amazonq/rules/**/*.md"
  ]
}
```

📝 `/agent create` 와는 달리, `/agent generate` 는 자동으로 prompt도 생성해줍니다.

#### 🎯 특정 모델 연결하기

원하는 모델을 지정하려면 model 필드를 설정:

```
"model": "claude-3.5-sonnet"
```

지원 모델 예시:

* "claude-3.5-sonnet"
* "claude-sonnet-4"
* null (기본 설정값 사용)

#### 📌 요약

<table data-header-hidden><thead><tr><th width="249.65936279296875"></th><th></th></tr></thead><tbody><tr><td>작업</td><td>명령어</td></tr><tr><td>커스텀 에이전트 생성</td><td>/agent create --name &#x3C;name></td></tr><tr><td>자동 생성 (AI 기반)</td><td>/agent generate</td></tr><tr><td>사용 중인 에이전트 목록 보기</td><td>/agent list</td></tr><tr><td>구성 편집</td><td>/agent edit --name &#x3C;name></td></tr><tr><td>적용하여 실행</td><td>q chat --agent &#x3C;name></td></tr><tr><td>컨텍스트 확인</td><td>/context show</td></tr></tbody></table>

이제  Amazon Q CLI에서 자신만의 커스텀 에이전트 환경을 구성하고 적용할 수 있습니다.

***

### 🧩 Custom Agent 구성 (Tool & Trust)

#### 🧪 Task 03 : Tools 및 권한 구성하기

이전 실습에서는 Amazon Q CLI에서 사용할 수 있는 도구(tools)와 신뢰(trust) 설정에 대해 알아보았습니다.

기본 커스텀 에이전트인 q\_cli\_default는 Amazon Q CLI에 내장된 모든 도구를 사용할 수 있도록 되어 있습니다.

하지만 새로 생성한 Custom Agent(예: python-developer)는 기본적으로 아무 도구도 포함하고 있지 않습니다.

#### 🧵 현재 세션에서 사용 가능한 도구 확인

```
/tools
```

출력 예시:

```
[python-developer] > /tools

Tool       Permission
▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
Built-in:
```

* 아무 도구도 활성화되지 않았습니다.

이는 현재 세션에서는 파일을 읽거나 쓰거나, 명령어 실행, AWS CLI 사용 등 아무 작업도 할 수 없다는 의미입니다.

### 🧩  Custom Agent 설정 파일 수정

이제 tools 항목을 설정하여 Amazon Q CLI의 기본 내장 도구들을 사용할 수 있도록 변경해 보겠습니다.

#### 🔍 JSON 파일 위치 확인

이전에 다음과 같은 명령으로 custom agent를 생성했습니다:

```
/agent create --name python-developer
```

* 이 방법은 Global Custom Agent를 생성하므로 JSON 설정 파일은 다음 경로에 저장됩니다:

```
~/.aws/amazonq/cli-agents/python-developer.json
```

#### ✏️ tools 설정 추가

파일을 열고 아래와 같이 수정하세요:

```
{
  "name": "python-developer",
  "prompt": null,
  "mcpServers": {},
  "tools": ["@builtin"],
  "toolAliases": {},
  "allowedTools": [],
  "resources": [
    "file://.amazonq/rules/**/*.md"
  ],
  "hooks": {},
  "toolsSettings": {}
}
```

<table data-header-hidden><thead><tr><th width="181.29998779296875"></th><th></th></tr></thead><tbody><tr><td>키</td><td>설명</td></tr><tr><td>"tools"</td><td>"@builtin"은 Amazon Q CLI의 모든 내장 도구를 활성화합니다.</td></tr><tr><td>"*"</td><td>와일드카드로 모든 도구를 허용</td></tr><tr><td>"execute_bash"</td><td>bash 명령 실행</td></tr><tr><td>"fs_read"</td><td>파일 시스템 읽기</td></tr><tr><td>"fs_write"</td><td>파일 시스템 쓰기</td></tr><tr><td>"report_issue"</td><td>GitHub issue 생성</td></tr><tr><td>"use_aws"</td><td>AWS CLI 명령 실행</td></tr></tbody></table>

#### 🔁 Amazon Q CLI 재시작

```
q chat --agent python-developer
```

#### 🔍 다시 도구 확인

```
/tools
```

출력 예시:

```
Tool              Permission
▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
Built-in:
- execute_bash    * trust read-only commands
- fs_read         * trusted
- fs_write        * not trusted
- report_issue    * trusted
- use_aws         * trust read-only commands
```

### 🧩 기본 권한 설정 변경하기

기본적으로 일부 도구는 “`not trusted`” 상태로 시작합니다.

이제 `allowedTools` 항목을 설정하여, 특정 도구를 자동으로 신뢰할 수 있도록 변경해 봅니다.

#### ✏️ JSON 수정

```
{
  "name": "python-developer",
  "prompt": null,
  "mcpServers": {},
  "tools": ["@builtin"],
  "toolAliases": {},
  "allowedTools": ["fs_read", "fs_write", "use_aws"],
  "resources": [
    "file://.amazonq/rules/**/*.md"
  ],
  "hooks": {},
  "toolsSettings": {}
}
```

#### 🔁 다시 Amazon Q CLI 재시작

```
q chat --agent python-developer
```

#### 🔍 권한 상태 재확인

```
/tools
```

변경된 출력 예시:

```
Tool              Permission
▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
Built-in:
- execute_bash    * trust read-only commands
- fs_read         * trusted
- fs_write        * trusted
- report_issue    * trusted
- use_aws         * trusted
```

🔐 이제 fs\_write 및 use\_aws도 기본적으로 신뢰(trusted) 상태입니다.

#### 🧪  Task04 - 기본 Custom Agent 설정하기

Amazon Q CLI를 실행할 때 매번 `--agent` 옵션을 쓰지 않고, 기본 커스텀 에이전트를 `python-developer`로 변경해 봅니다.

* 기본 에이전트 설정 명령

```
/agent set-default -n python-developer
```

출력 예시:

```
✓ Default agent set to 'python-developer'. This will take effect the next time q chat is launched.
```

* 재시작하여 확인

```
q chat
```

→ \[python-developer] > 프롬프트가 나타나면 성공!

#### ⚙️ 설정 파일 확인 (선택)

```
q settings open
```

설정 파일에 다음 항목이 추가되어 있어야 합니다:

```
chat.defaultAgent: "python-developer"
```

***

### 🧩  Custom Agent 간 전환하기 

세션 도중에 커스텀 에이전트를 바꾸고 싶을 때는 다음 명령으로 가능합니다:

```
/agent swap {agent-name}
```

예:

```
/agent swap python-dev
```

에이전트를 전환하면 MCP 서버 연결, 도구 및 권한 설정, 컨텍스트 리소스 등이 모두 자동으로 적용됩니다.

#### ✅ 요약

| 작업          | 명령어                          |
| ----------- | ---------------------------- |
| 현재 도구 보기    | /tools                       |
| 도구 활성화      | JSON에서 "tools" 설정            |
| 기본 도구 신뢰 설정 | JSON에서 "allowedTools" 설정     |
| 기본 에이전트 설정  | /agent set-default -n {name} |
| 에이전트 간 전환   | /agent swap {name}           |

#### 🔒 보안 관련 주의사항

* 도구 권한은 가능한 최소한으로 설정하세요.
* 특히 execute\_bash, fs\_write, use\_aws와 같은 도구는 신중하게 신뢰 설정을 하세요.
* 팀과 공유할 때는 보안 규칙을 문서화하고 검토할 것을 권장합니다.

이제  Amazon Q CLI의 커스텀 에이전트에서 사용할 도구와 권한을 정교하게 제어할 수 있습니다.

이 구성은 에이전트마다 다르게 설정할 수 있어, 다양한 프로젝트에 맞춰 최적화된 환경을 만들 수 있습니다.

***

### 🧩 Context Hooks 구성

#### 📌 Context Hook이란?

Context Hook은 Amazon Q CLI에서 대화 중에 자동으로 컨텍스트(문맥)를 주입할 수 있는 기능입니다.

Hook은 명령어(command)를 실행한 결과를 컨텍스트로 포함시켜, Amazon Q CLI가 더 정확하고 상황에 맞는 응답을 할 수 있도록 돕습니다.

이러한 Context Hook은 Custom Agent 내부에서 구성합니다.

#### 📚 Amazon Q CLI는 다음과 같은 4가지 유형의 Context Hook을 지원합니다:

<table data-header-hidden><thead><tr><th width="175.98431396484375"></th><th></th></tr></thead><tbody><tr><td>Hook 유형</td><td>설명</td></tr><tr><td>agentSpawn</td><td>대화 세션 시작 시 한 번만 실행. 결과는 전체 세션 동안 유지되는 컨텍스트로 추가됩니다.</td></tr><tr><td>userPromptSubmit</td><td>사용자의 프롬프트가 제출될 때마다 실행. 해당 프롬프트에만 결과가 포함됩니다.</td></tr><tr><td>preToolUse</td><td>도구(tool)가 실행되기 전에 실행됨. 도구 실행을 검증하거나 차단할 때 유용합니다.</td></tr><tr><td>postToolUse</td><td>도구 실행 후 결과가 반환될 때 실행됨. 도구 출력값을 후처리할 수 있습니다.</td></tr></tbody></table>

📘 추가 제약사항은 [Behavior and limitations](https://docs.aws.amazon.com) 문서를 참조하세요.

#### 🔎 현재 세션에서 Hook 확인하기

```
/hooks
```

출력 예시:

```
[python-developer] > /hooks

No hooks are configured.
```

### 🧪 Task-05: Per-Prompt Hook 만들기 (Pirate Style)

\
이번 실습에서는 매번 프롬프트를 제출할 때마다 해적처럼 말하고 유머를 섞도록 하는 Hook을 만들어 보겠습니다.

#### 1. pirate.md  파일 생성

Amazon Q CLI를 종료한 뒤, 현재 디렉토리에 pirate.md 파일을 만들고 아래 내용을 작성합니다:

```
“해적처럼 말하고, 어이없는 농담을 해라.”
```

#### 2. Custom Agent JSON 수정

기존의 python-developer 에이전트 설정 파일을 아래와 같이 수정합니다:

```
{
  "$schema": "https://raw.githubusercontent.com/aws/amazon-q-developer-cli/refs/heads/main/schemas/agent-v1.json",
  "name": "python-developer",
  "description": "",
  "prompt": null,
  "mcpServers": {},
  "tools": ["*"],
  "toolAliases": {},
  "allowedTools": ["fs_read","fs_write","use_aws"],
  "resources": [
    "file://.amazonq/rules/**/*.md"
  ],
  "hooks": {
    "userPromptSubmit": [
      {
        "command": "cat pirate.md"
      }
    ]
  },
  "toolsSettings": {}
}
```

#### 3. Amazon Q CLI 재시작 및 Hook 확인

```
q chat --agent python-developer
/hooks
```

출력 예시:

```
[python-developer] > /hooks

userPromptSubmit:
  - cat pirate.md
```

#### 4️. 테스트 프롬프트 입력

```
“당신이 사용 중인 모델은 무엇인가요?”
```

👉 출력 결과에 해적 말투와 유머가 포함되는지 확인해 보세요!\


이 Hook은 cat pirate.md의 출력이 매 프롬프트마다 컨텍스트로 주입되기 때문에 동작합니다.

#### 🎯 Session 시작 시 실행되는 Hook : agentSpawn

이번에는 Amazon Q CLI 세션을 시작할 때 자동으로 실행되는 Hook을 설정해보겠습니다.

예: 현재 시간과 날짜를 컨텍스트에 포함시키기

```
"hooks": {
  "agentSpawn": [
    {
      "command": "echo 'current date and time is:' && date"
    }
  ]
}
```

📌 agentSpawn Hook은 대화가 시작될 때 한 번만 실행되며, 그 출력은 전체 세션의 고정 컨텍스트가 됩니다.

### 🧩 Tool 관련 Hook 설정하기

\
Amazon Q CLI에서 사용 가능한 도구들(ex: fs\_write, execute\_bash)에 대해 도구 실행 전후에 Hook을 설정할 수 있습니다.

이때는 Hook 설정에 matcher 필드를 추가로 사용합니다.

#### 예시: preToolUse, postToolUse

```
"hooks": {
  "preToolUse": [
    {
      "matcher": "execute_bash",
      "command": "{ echo \"$(date) - Bash command:\"; cat; echo; } >> /tmp/bash_audit_log"
    }
  ],
  "postToolUse": [
    {
      "matcher": "fs_write",
      "command": "cargo fmt --all"
    }
  ]
}
```

<table data-header-hidden><thead><tr><th width="137.5843505859375"></th><th></th></tr></thead><tbody><tr><td>Hook 타입</td><td>설명</td></tr><tr><td>preToolUse</td><td>execute_bash가 실행되기 전에 실행됨. 실행 커맨드를 /tmp/bash_audit_log에 기록</td></tr><tr><td>postToolUse</td><td>fs_write 실행 이후에 cargo fmt로 코드 포맷팅 수행</td></tr></tbody></table>

📌 matcher 필드는 Hook이 어떤 도구에 연동되는지를 명시합니다.

### 📌 요약

| Hook 유형    | 키 값              | 실행 시점             | 사용 예         |
| ---------- | ---------------- | ----------------- | ------------ |
| Session 시작 | agentSpawn       | Amazon Q CLI 실행 시 | 환경 준비, 날짜 기록 |
| 프롬프트 전     | userPromptSubmit | 사용자 입력 시          | 맥락 설정, 말투 변경 |
| 도구 실행 전    | preToolUse       | 도구 실행 직전          | 로깅, 차단       |
| 도구 실행 후    | postToolUse      | 도구 실행 직후          | 포맷팅, 검증      |

### 📦 참고

* .md 파일, 쉘 커맨드 등 자유롭게 Hook에 활용 가능
* Hook 설정은 Custom Agent마다 독립적으로 구성됩니다
* 민감 작업 시에는 로깅 또는 사전 검증 Hook을 추천합니다

이제  Amazon Q CLI에서 Context Hook을 자유자재로 구성할 수 있습니다. 이를 통해 보다 동적인 세션 운영과 컨텍스트 기반 개발 지원이 가능합니다.

***

### 🧩  MCP Servers 설정

앞서 이 실습의 초반부에서 MCP(Model Context Protocol)와 Amazon Q CLI에서 이를 세션에 통합하는 방법에 대해 소개했습니다. 지금까지 우리는 Custom Agent(사용자 정의 에이전트)를 사용하여 context 제공을 위한 리소스를 추가하고, 사용할 수 있는 tools(도구) 설정 방법과 context hooks(후크) 생성 방법을 배웠습니다. 이 모든 작업은 Custom Agent의 JSON 구성 파일을 편집하여 수행되었습니다.

MCP Server는 Tools, Resources, Prompts를 노출할 수 있으며, Amazon Q CLI는 이 중 Tools와 Prompts를 사용할 수 있습니다.

Tools를 제공하는 MCP Server를 추가하면, 이는 Amazon Q CLI의 기존 도구들과 동일하게 동작하며, 접근 제어와 권한 설정도 동일한 방식으로 관리할 수 있습니다.

이번 실습에서는 우리가 이전에 설정한 "python-developer" Custom Agent에 AWS Documentation MCP Server를 추가해보겠습니다. 이 MCP Server는 다양한 AWS 문서를 검색하고 읽을 수 있는 도구를 제공합니다.

```json
{
  "mcpServers": {
    "awslabs.aws-documentation-mcp-server": {
      "command": "uvx",
      "args": ["awslabs.aws-documentation-mcp-server@latest"],
      "env": {
        "FASTMCP_LOG_LEVEL": "ERROR",
        "AWS_DOCUMENTATION_PARTITION": "aws"
      },
      "disabled": false,
      "autoApprove": []
    }
  }
}
```

AWS MCP Servers 목록은 [AWS MCP Server Directory](https://github.com/awslabs/amazon-q-devtools-mcp-servers)에서 확인할 수 있으며, 각 MCP Server가 제공하는 기능 및 설치 방법도 포함되어 있습니다.

#### 🧪 Task-06: MCP Server 통합

기존의 `python-developer` 에이전트 구성에 위의 `mcpServers` 블록을 추가합니다.

```
{
  "$schema": "https://raw.githubusercontent.com/aws/amazon-q-developer-cli/refs/heads/main/schemas/agent-v1.json",
  "name": "python-developer",
  "description": "",
  "prompt": null,
  "mcpServers": {
    "awslabs.aws-documentation-mcp-server": {
      "command": "uvx",
      "args": ["awslabs.aws-documentation-mcp-server@latest"],
      "env": {
        "FASTMCP_LOG_LEVEL": "ERROR",
        "AWS_DOCUMENTATION_PARTITION": "aws"
      }
    }
  },
  "tools": ["*"],
  "toolAliases": {},
  "allowedTools": ["fs_read", "fs_write", "use_aws"],
  "resources": [
    "file://.amazonq/rules/**/*.md"
  ],
  "hooks": {},
  "toolsSettings": {}
}
```

&#x20;추가 후 Amazon Q CLI를 다시 시작하면 MCP 서버가 초기화되며, 다음과 같은 메시지가 출력됩니다:

```
⠏ 0 of 1 mcp servers initialized. ctrl-c to start chatting now
```

세션이 시작된 후, `/mcp` 명령어로 MCP Server가 정상적으로 로드되었는지 확인합니다:

```
/mcp
```

출력 예:

```
[python-developer] > /mcp

awslabs.aws-documentation-mcp-server
✓ awslabs.aws-documentation-mcp-server loaded in 10.37 s
```

### 🎯 MCP 서버 도구(Tools) 설정하기

MCP 서버를 통합하면 해당 서버가 제공하는 도구(Tools)을 사용할 수 있게 되며, /tools 명령어를 통해 확인할 수 있습니다. 이 MCP 도구(Tools)들도 Amazon Q CLI 내 기본 도구(Tools)과 동일하게 신뢰 여부(trusted/untrusted)를 설정할 수 있습니다.

#### 🧪  Task-07: MCP Tools 구성 및 권한 설정

MCP Server가 정상적으로 로드되면 해당 MCP Server가 제공하는 도구들이 `/tools` 명령어를 통해 표시됩니다.&#x20;

도구(Tools) 목록을 확인합니다:

```
/tools
```

예시:

```
Tool                      Permission
▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
Built-in:
- execute_bash            * trust read-only commands
- fs_read                 * trusted
- fs_write                * trusted
- report_issue            * trusted
- use_aws                 * trusted

awslabs.aws-documentation-mcp-server (MCP):
- read_documentation      * not trusted
- recommend               * not trusted
- search_documentation    * not trusted
```

Custom Agent의 JSON 파일을 다음과 같이 수정하여,  특정 MCP Tools만 활성화하고 일부에 대해서만 신뢰 권한을 부여할 수 있습니다:

```json
{
  "$schema": "https://raw.githubusercontent.com/aws/amazon-q-developer-cli/refs/heads/main/schemas/agent-v1.json",
  "name": "python-developer",
  "description": "",
  "prompt": null,
  "mcpServers": {
    "awslabs.aws-documentation-mcp-server": {
      "command": "uvx",
      "args": ["awslabs.aws-documentation-mcp-server@latest"],
      "env": {
        "FASTMCP_LOG_LEVEL": "ERROR",
        "AWS_DOCUMENTATION_PARTITION": "aws"
      },
      "disabled": false
    }
  },
  "tools": [
    "fs_read",
    "fs_write",
    "use_aws",
    "@awslabs.aws-documentation-mcp-server/read_documentation",
    "@awslabs.aws-documentation-mcp-server/search_documentation"
  ],
  "toolAliases": {},
  "allowedTools": [
    "@awslabs.aws-documentation-mcp-server/read_documentation"
  ],
  "resources": [
    "file://.amazonq/rules/**/*.md"
  ],
  "hooks": {},
  "toolsSettings": {}
}
```

Amazon Q CLI를 재시작하고 `/tools` 명령어를 통해 구성 결과를 확인할 수 있습니다.

```
Tool                      Permission
Built-in:
- fs_read                 * trusted
- fs_write                * not trusted
- use_aws                 * trust read-only commands

awslabs.aws-documentation-mcp-server (MCP):
- read_documentation      * trusted
- search_documentation    * not trusted
```

#### ✅ MCP Tool 테스트

프롬프트에 다음과 같이 입력해보세요:

```
MWAA 작업자 크기에 대한 AWS 문서를 확인해줘
```

`search_documentation` Tool은 신뢰되지 않은 상태이므로 실행 시 사용자에게 신뢰 여부를 묻게 됩니다.

&#x20;`t`를 입력하면 세션 전체에서 이 도구를 신뢰하게 되며, 이후 `read_documentation`은 미리 신뢰되어 바로 실행됩니다.

MCP 서버는 매우 강력하며, 다음과 같은 유연한 구성이 가능합니다:

* 도구 단위의 신뢰/비신뢰 설정
* MCP 서버별로 개별 도구(Tools) 허용
* 다양한 AWS 서비스 문서를 실시간 검색 및 활용

사용자 정의 에이전트를 통해 세션에 정교한 MCP 통합이 가능하며, 팀원들과 설정을 공유하여 일관성 있는 개발 환경을 만들 수 있습니다.  Custom Agent를 통해 MCP Server를 매우 유연하고 세밀하게 통합 및 제어할 수 있으며, 프로젝트에 맞는 MCP Tool만 선택적으로 활성화할 수 있어 협업 시 일관된 작업 환경을 제공할 수 있습니다.

***



물론입니다. 아래는 Clashing tool names - using toolAliases 항목에 대한 고급 한국어 번역이며, 원문의 구조와 기술 용어를 최대한 보존하고 한국어-영문 병기를 사용하였습니다:

***

### 도구 이름 충돌 방지 - toolAliases 사용하기

Amazon Q CLI에 MCP 서버(MCP Server)를 추가할 때 고려해야 할 중요한 점 중 하나는 도구(Tools) 이름 충돌(tool name clash) 가능성입니다.

예를 들어, get\_issues라는 이름의 도구(Tools)이 있다고 가정해 보겠습니다. 여기에 GitHub와 GitLab MCP 서버를 통합하면, 두 서버 모두 동일한 이름의 툴(get\_issues)을 제공하게 됩니다. 이 경우, 어떤 MCP 서버의 도구(Tools)을 사용할지 명확히 지정해야 할 필요가 생깁니다.\


이러한 충돌을 관리하기 위해, 사용자 정의 에이전트(Custom Agent)의 JSON 구성 파일에서 toolAliases 항목을 사용하여 각 MCP 도구(Tools)에 대한 별칭(alias) 을 정의할 수 있습니다.

예시:

```
"toolAliases": {
  "@github-mcp/get_issues": "github_issues",
  "@gitlab-mcp/get_issues": "gitlab_issues"
}
```

이렇게 구성하면 충돌을 피하면서도 명확하게 도구를 사용할 수 있습니다.

### toolAliases 를 활용한 도구 참조 방식 개선

앞에서 소개한 toolAliases는 단순히 네임스페이스 충돌을 해결하기 위한 용도 외에도, 개발자 경험(Developer Experience, DX)을 개선하기 위한 수단으로도 사용할 수 있습니다.

예를 들어, 도구 이름이 너무 길거나 복잡하다면, 더 짧고 직관적인 이름으로 별칭을 부여할 수 있습니다.

예시:

```
{
  "toolAliases": {
    "@aws-cloud-formation/deploy_stack_with_parameters": "deploy_cf",
    "@kubernetes-tools/get_pod_logs_with_namespace": "pod_logs"
  }
}
```

이런 방식은 자주 사용하는 도구(Tools)에 대해 더 짧고 명확한 이름을 제공하므로, 명령어 입력 시 편의성을 높이고, 실수를 줄이며, 가독성도 향상시킬 수 있습니다.

📌 정리

* MCP 서버 통합 시 동일 이름의 도구(Tools)이 있을 수 있으므로 toolAliases로 충돌 방지 필요
* 개발자가 자주 사용하는 도구(Tools)의 이름을 더 짧고 기억하기 쉽게 별칭으로 정의 가능
* 에이전트 JSON 내 toolAliases 항목에서 구성





