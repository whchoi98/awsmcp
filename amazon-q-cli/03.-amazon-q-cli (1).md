# 03. Amazon Q CLI 고급 기능

## 🧩 01. Model Context Protocol (MCP)란?

MCP는 AI 애플리케이션이 외부 도구 및 데이터 소스에 표준화된 방식으로 연결되도록 해주는 프로토콜입니다.

AI 버전의 USB-C와 유사하다고 이해하면 됩니다.

***

#### ✅ MCP의 구성 요소

<table data-header-hidden><thead><tr><th width="255.9375"></th><th></th></tr></thead><tbody><tr><td>구성 요소</td><td>설명</td></tr><tr><td>MCP Host</td><td>Amazon Q CLI와 같은 AI 애플리케이션 자체</td></tr><tr><td>MCP Client</td><td>Host 내부에서 동작하며 MCP Server와 통신</td></tr><tr><td>MCP Server</td><td>특정 기능을 수행하는 실행 파일 또는 라이브러리 (대부분 로컬에서 실행됨)</td></tr></tbody></table>

#### ⚙️ MCP Server 실행 방식

| 방식              | 설명                                   |
| --------------- | ------------------------------------ |
| Native 실행       | 로컬 환경에 직접 라이브러리 설치 및 실행              |
| Container 기반 실행 | 종속성이 복잡하거나 충돌 가능성이 있을 경우 컨테이너 사용이 유리 |

{% hint style="info" %}
MCP Server는 보안상 위험 요소도 될 수 있으므로 신뢰된 소스만 설치하고 실행해야 합니다.
{% endhint %}

***

#### 🔐 MCP 보안 모델 핵심

* 명시적 권한 부여: MCP Tool 사용 전 명시적으로 ‘t’를 눌러 허용
* 로컬 실행 및 격리: 각 MCP Server는 개별 프로세스로 로컬에서 격리 실행
* 가시성 확보: 어떤 Tool이 어떤 행동을 하는지 명확히 표시

***

### 🧪 Task 1 – Promptz MCP Server 추가 실습 

#### ✅ 1. MCP 설정 파일 생성

```
cd ~/.aws/amazonq
nano mcp.json
```

다음 내용 입력:

```
{
  "mcpServers": {
    "promptz.dev/mcp": {
      "command": "npx",
      "args": [
        "-y",
        "@promptz/mcp"
      ],
      "env": {
        "PROMPTZ_API_URL": "https://retdttpq2ngorbx7f5ht4cr3du.appsync-api.eu-central-1.amazonaws.com/graphql",
        "PROMPTZ_API_KEY": "da2-45yiufdo5rcflbas7rzd3twble"
      },
      "disabled": false,
      "autoApprove": []
    }
  }
}
```

#### ✅ 2. 상태 확인

```
q mcp status --name promptz.dev/mcp
```

출력 예시:

```
Scope   : 🌍 global
File    : /Users/yourname/.aws/amazonq/mcp.json
Command : npx
Env Vars: PROMPTZ_API_URL, PROMPTZ_API_KEY
```

주의: MCP Server에 따라 추가적으로 python, uv 등이 필요할 수 있습니다.

***

#### ✅ 3. Q CLI 실행 및 MCP 서버 로딩 확인

```
q
```

시작 시 출력 (잠깐 뜹니다):

```
✓ promptzdevmcp loaded in 1.29 s
✓ 1 of 1 mcp servers initialized
```

***

#### ✅ 4. MCP 서버 사용 테스트

```
새로운 Flask 앱을 생성해줘. 프롬프트는 Promptz에서 가져와 사용해줘.
```

Amazon Q 응답 예:

```
I'll help you create a new Flask application. Let me check for available prompts from promptz.dev
```

MCP Server에서 tool 호출 시 \[y/n/t] 로 확인 요청됩니다.

* `t` 입력하여 해당 Tool을 세션 내 신뢰(trust)

***

#### ✅ 5. MCP 도구 목록 확인

```
/tools
```

예시 출력:

```
Tool                                Permission
...
promptzdevmcp___list_prompts        trusted
promptzdevmcp___get_prompt          not trusted
```

→ MCP Server를 통해 추가된 tool들은 명시적으로 trust를 해야 실행 가능

***

#### 📌 참고

* MCP 전역 설정 파일: \~/.aws/amazonq/mcp.json
* MCP 프로젝트별 설정: 프로젝트 경로/.amazonq/mcp.json
* MCP 관리 명령어:

```
q mcp list
q mcp add/remove/import
q mcp status --name [서버명]
```

***

🧩 02. Model Context Protocol (MCP) Prompt\



MCP 서버는 다음과 같은 세 가지 유형의 리소스를 제공합니다:

1. Tools
   * AI 코딩 어시스턴트가 호출할 수 있는 함수 정의
   * 가장 일반적이며, 명령 실행 목적
2. Resources
   * 서버와 클라이언트 간의 상태 데이터 공유 (예: 설정 파일, 동적 사용자 데이터, 이미지 등)
3. Prompts
   * 일관된 사용자 프롬프트 템플릿을 생성해 재사용 가능하게 함
   * Amazon Q CLI에서는 /prompts 명령어를 통해 사용 가능

***

### 🧪 Task2: MCP Prompt 서버 만들기

1. 새 터미널을 열고 작업 디렉터리 생성:

```
mkdir -p ~/projects/mcp-prompts
cd ~/projects/mcp-prompts

```

2. mcp-server.py 파일 생성 후 아래 코드 추가:

```python
import asyncio
import sys

from crawl4ai import *  # 웹 크롤링 기능을 제공하는 라이브러리
from mcp.server.fastmcp import Context, FastMCP  # MCP 서버 및 컨텍스트 관련 모듈

# MCP 서버 인스턴스를 생성하고 이름을 "ContextScraper"로 지정
mcp = FastMCP("ContextScraper")

# MCP에서 사용 가능한 도구(tool)로 등록되는 비동기 크롤링 함수 정의
@mcp.tool()
async def crawl(url: str, ctx: Context) -> str:
    """
    주어진 웹페이지 URL을 크롤링하여 마크다운 형식으로 반환
    """
    # 표준 출력을 무시하기 위해 /dev/null로 리디렉션
    dev_null = open("/dev/null", "w")
    sys.stdout = dev_null

    # Crawl4AI의 비동기 크롤러를 사용하여 웹페이지 내용 크롤링
    async with AsyncWebCrawler() as crawler:
        result = await crawler.arun(url=url)  # URL로 크롤링 수행
        return result.markdown  # 크롤링된 결과를 마크다운 형식으로 반환

# MCP에서 사용할 프롬프트 정의 - 크롤링 도구 사용 프롬프트
@mcp.prompt()
def create_context_from_url(url: str) -> str:
    """
    URL을 입력 받아 해당 페이지를 크롤링하고
    결과를 ".amazonq/rules/" 디렉토리에 마크다운 파일로 저장하는 프롬프트를 생성
    """
    return f'Use the crawl tool to crawl url={url}. Write the webpage content to a markdown file in ".amazonq/rules/" of the current directory. Choose a fitting name for the file'

# MCP에서 사용할 프롬프트 정의 - 신규 프로젝트 초기 구조 생성
@mcp.prompt()
def create_new_project() -> str:
    """
    새로운 프로젝트 구조를 생성하는 프롬프트
    src 디렉토리를 생성하고 내부에 templates, models, routes, static 서브디렉토리와 README.md를 추가
    """
    return f'Create a new project layout. Create a top level src directory, and in the src directory create subdirectories for templates, models, routes, and static. Add a README.md to the src directory.'

```

2. 가상 환경 및 종속성 설치:

```sh
python -m venv .mcp
source .mcp/bin/activate
pip install mcp crawl4ai "mcp[cli]"

```

3. .amazonq/mcp.json 구성 생성:

```
mkdir .amazonq
touch .amazonq/mcp.json
```

4. .amazonq/mcp.json에 아래 내용을 추가 합니다.

```json
{
    "mcpServers": {
        "ContextScraper": {
            "command": "uv",
            "args": ["run", "--with", "mcp", "mcp", "run", "mcp-server.py"]
        }
    }
}

```

4. 디렉터리 구조:

```
mcp-prompts/
├── .mcp/
├── .amazonq/
│   └── mcp.json
└── mcp-server.py

```

***

### ✅ Amazon Q CLI에서 MCP Prompt 사용

1. Amazon Q CLI 세션 시작 후, 다음 입력:

```
/prompts list

```

2. 출력 예시:

```
> /prompts list

Prompt                    Arguments (* = required)
▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔
context_scraper (MCP):
- create_context_from_url url*
- create_new_project

```

3. 프롬프트 실행 예시:

```
@create_new_project
```

3. URL 기반 컨텍스트 추가 예시:

```
@create_context_from_url url=http://whchoi98.gitbook.io/awsmcp/amazon-q-cli/02.-amazon-q-cli
```

4. 웹페이지 내용을 크롤링하여 .amazonq/rules/에 마크다운 파일로 저장됨
5. 완료되면 다음 명령어를 실행합니다.

```
/context show
```

이제 해당 내용이 여러분의 컨텍스트에 추가된 것이 보입니다. 이 기능은 새로운 라이브러리의 API 문서를 추가하고, 이를 컨텍스트에 포함시켜 작업하고자 할 때 매우 유용하게 활용될 수 있습니다.

***

#### 💡 요약

* MCP Prompt를 통해 반복 가능한 명령 템플릿을 만들 수 있음
* 사용자 상호작용을 단순화하고 일관되게 구성 가능
* @{prompt} 형식으로 프롬프트 호출 가능
* AI 어시스턴트를 위한 워크플로우 자동화에 유용

***

## 🧩 03. **Context Hooks**

***

### 📌 Context Hooks란? 

Amazon Q CLI의 Context Hooks는 Q Developer CLI와의 대화에 자동으로 컨텍스트를 주입하는 기능입니다.

매번 수동으로 /context 명령어를 입력하지 않고,

지정된 명령어를 실행해 그 출력을 컨텍스트로 포함시킬 수 있습니다.

***

#### ✅ 지원되는 Context Hook 유형

1. Conversation Start Hooks
   * 세션이 시작될 때 단 한 번 실행
   * 생성된 컨텍스트는 전체 세션에 유지됨
2. Per-Prompt Hooks
   * 사용자가 프롬프트를 입력할 때마다 실행됨
   * 출력은 그 프롬프트에만 적용

***

#### 🔍 현재 Context Hooks 확인

```
/context hooks
```

출력 예시:

```
🌍 global:
  Conversation Start: <none>
  Per Prompt: <none>

👤 profile (default):
  Conversation Start: <none>
  Per Prompt: <none>
```

***

### 🧪 Task 3: Pirate Hook 추가하기

#### 1. Amazon Q CLI 종료 후, 다음 파일 생성

```
echo -e "talk like a pirate\nmake jokes" > MYHOOK.md
```

#### 2. Hook 등록

```
/context hooks add pirate --trigger per_prompt --command "cat MYHOOK.md"
```

이 명령은 매 프롬프트마다 MYHOOK.md 파일을 읽어 컨텍스트에 포함시킵니다.

예상 출력:

```
Added profile hook 'pirate'.
```

#### 🧪 테스트 

다음 프롬프트를 입력:

```
JSON 형식의 날짜 문자열을 반환하는 간단한 Flask 애플리케이션을 만들어줘.
```

***

### 🔧 추가 정보

* 글로벌 Hook으로 등록하고 싶다면 --global 플래그 사용
* Hook은 .amazonq/context.json에 저장됨
* 예시:

```json
{
  "paths": ["project-standards.md"],
  "hooks": {
    "todo": {
      "trigger": "per_prompt",
      "type": "inline",
      "disabled": false,
      "timeout_ms": 30000,
      "max_output_size": 10240,
      "cache_ttl_seconds": 0,
      "command": "cat MYHOOK.md"
    }
  }
}
```

***

### 🔍 모든 컨텍스트 요약 보기

```
/context show --expand
```

→ 현재 세션의 글로벌/로컬 컨텍스트 파일 및 Hook 구성 정보가 요약되어 표시됨

→ 컨텍스트 파일이 많으면, 요약은 상단에 표시되므로 스크롤 필요

출력 예시

```
🌍 global:
    .amazonq/rules/**/*.md (2 matches)
    README.md (1 match)
    AmazonQ.md

    🔧 Hooks:
    On Session Start:
      <none>
    Per User Message:
      <none>

👤 profile (default):
    <none>

    🔧 Hooks:
    On Session Start:
      <none>
    Per User Message:
      <none>
```

이와 같은 방식으로, 사용자는 명령 실행 결과를 실시간 컨텍스트로 주입하여 보다 유연하고 동적인 개발자 환경을 구축할 수 있습니다.

***

## 🧩 04. Amazon Q CLI – 대화 관리 기능

\
Amazon Q CLI는 단일 세션 내에서만 대화를 이어갈 수 있는 것이 아니라, 이전 세션의 대화 내용을 저장하고 다시 불러올 수 있는 기능을 제공합니다.

***

#### ✅ 1. 대화 이어가기

```
--resume
```

옵션

```
q chat --resume
```

* 현재 디렉터리에 있는 이전 세션의 대화 내용을 자동으로 불러옵니다
* MCP 서버가 있는 경우 함께 초기화됩니다
* 출력 예시:

```
✓ promptzdevmcp loaded in 2.83 s
✓ 1 of 1 mcp servers initialized.
Picking up where we left off...
```

{% hint style="info" %}
이 기능은 현재 디렉터리를 기준으로 이전 대화를 추적합니다
{% endhint %}

***

#### ✅ 2. 대화 저장

```
/save {이름}
```

Amazon Q CLI 대화 중 언제든지 현재 상태를 저장할 수 있습니다:

```
> /save project-customer-survey
```

* 결과:

```
✔ Exported conversation state to project-customer-survey.json
```

* 이 파일은 현재 디렉터리에 .json 형식으로 저장됩니다 (예: project-customer-survey.json)

***

#### ✅ 3. 대화 불러오기

```
/load {파일명}
```

저장된 대화를 다시 불러오고 싶다면:

```
> /load project-customer-survey.json
```

* 이전 대화의 프롬프트, 응답, context 모두 복원됨
* 불러온 후에는 이어서 대화 가능

***

### 🧪 Task 19 – 실습

1. Amazon Q CLI에서 다음 명령 입력:

```
> /save project-customer-survey

```

2. 새로운 터미널 창 열기 → 현재 디렉터리에 JSON 파일이 생성되었는지 확인:

```
ls project-customer-survey.json
```

3. Amazon Q CLI 종료 후 다시 실행:

```
q chat
```

3. 다음 명령으로 저장된 대화 불러오기:

```
> /load project-customer-survey.json
```

4. 대화 이어가기 예:

```
> 고객 설문 앱에서 어떤 피드백 트렌드가 나타나고 있나요?
```

***

### 📦 저장된 대화의 활용 예

* 대화 요약 및 회고
* 팀과 공유용 이력 보관
* 하나의 프로젝트에 여러 대화 시나리오 분리 관리
* 대화 기반 문서화 (JSON → Markdown으로 변환 가능)

***

### 📝 명령어 요약

<table data-header-hidden><thead><tr><th width="223.2734375"></th><th></th></tr></thead><tbody><tr><td>명령어</td><td>설명</td></tr><tr><td>q chat --resume</td><td>현재 디렉터리의 마지막 대화 이어서 시작</td></tr><tr><td>/save {이름}</td><td>현재 대화 저장 (예: project.json)</td></tr><tr><td>/load {파일명}</td><td>저장된 대화 불러오기</td></tr><tr><td>Ctrl + C</td><td>대화 종료</td></tr></tbody></table>

***

