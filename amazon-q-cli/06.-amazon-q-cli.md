# 06. Amazon Q CLI로 코드 이해하기

### 🧭 Overview

이 실습에서는 지금까지 구축한 애플리케이션을 바탕으로 코드베이스를 문서화하여, 향후 개발자들이 이 코드베이스를 더 잘 이해할 수 있도록 만드는 방법을 살펴봅니다.

***

### 🧪   Task 01 – 코드 구조 분석하기

Amazon Q CLI는 처음 접하는 코드베이스를 탐색할 때 매우 유용한 도구입니다. 전체 애플리케이션의 구조를 설명하거나, 특정 함수나 클래스에 대해 심층 분석할 수 있습니다.

1. 먼저 프로젝트 디렉토리 내 `README.md` 파일을 삭제합니다.
2. Amazon Q CLI를 실행하고, 프롬프트에서 다음 명령어를 입력합니다:

```
현재 프로젝트 작업 공간의 코드베이스를 탐색해 주세요.
이 애플리케이션의 핵심 아키텍처 구성 요소를 설명한 다음,어떻게 동작하는지 단계별로 안내해 주세요.
```

📋 출력 예시:

```
# 고객 설문조사 웹 애플리케이션 아키텍처 분석

## 핵심 아키텍처 구성 요소

이 애플리케이션은 Flask 웹 프레임워크를 기반으로 한 고객 설문조사 시스템으로, 다음과 같은 핵심 아키텍처 구성 요소로 이루어져 있습니다:

### 1. 애플리케이션 팩토리 패턴
• **app.py**: 애플리케이션의 진입점으로, Flask 애플리케이션 인스턴스를 생성하고 구성하는 create_app() 함수를 제공합니다.
• 이 패턴은 애플리케이션을 모듈화하고 테스트하기 쉽게 만들어줍니다.

### 2. 확장 모듈
• **extensions.py**: Flask 확장 기능을 초기화하는 모듈입니다.
  • SQLAlchemy: 데이터베이스 ORM
  • LoginManager: 사용자 인증 관리

### 3. 데이터 모델
• **models/**: 데이터베이스 모델을 정의하는 모듈
  • User: 사용자 정보 관리
  • Survey: 설문조사 정보
  • SurveyOption: 설문조사 옵션
  • SurveyResponse: 설문조사 응답

### 4. 라우트 및 뷰
• **routes/**: URL 라우팅과 뷰 함수를 정의하는 모듈
  • auth.py: 인증 관련 라우트 (로그인, 회원가입, 로그아웃)
  • main.py: 메인 페이지 및 대시보드 라우트
  • survey.py: 설문조사 관련 라우트 (생성, 조회, 응답)

### 5. 템플릿
• **templates/**: Jinja2 템플릿 파일
  • 사용자 인터페이스 구성 요소

### 6. 정적 파일
• **static/**: CSS, JavaScript 등의 정적 파일

### 7. 배포 구성
• **wsgi.py**: WSGI 애플리케이션 진입점
• **entrypoint.sh**: 컨테이너 환경에서 애플리케이션 실행을 위한 스크립트
• **gunicorn_config.py**: Gunicorn 설정

## 애플리케이션 동작 방식

### 1. 초기화 단계
1. 애플리케이션 생성:
   • wsgi.py에서 create_app() 함수를 호출하여 Flask 애플리케이션 인스턴스를 생성합니다.
   • 환경 변수에서 설정을 로드합니다 (SECRET_KEY, DATABASE_URL 등).

2. 확장 초기화:
   • db.init_app(app): SQLAlchemy 초기화
   • login_manager.init_app(app): Flask-Login 초기화

3. 블루프린트 등록:
   • auth_bp: 인증 관련 라우트 (/auth/*)
   • main_bp: 메인 페이지 라우트 (/)
   • survey_bp: 설문조사 관련 라우트 (/survey/*)

4. 데이터베이스 초기화:
   • db.create_all(): 데이터베이스 테이블 생성

### 2. 사용자 인증 흐름
1. 회원가입:
   • 사용자가 이메일과 비밀번호를 입력합니다.
   • 비밀번호는 해시되어 저장됩니다.
   • 새 사용자 레코드가 데이터베이스에 생성됩니다.

2. 로그인:
   • 사용자가 이메일과 비밀번호를 입력합니다.
   • 비밀번호가 검증되면 세션에 사용자 ID가 저장됩니다.
   • 로그인 성공 시 대시보드로 리디렉션됩니다.

3. 인증 상태 유지:
   • @login_required 데코레이터를 사용하여 인증이 필요한 라우트를 보호합니다.
   • current_user 객체를 통해 로그인한 사용자 정보에 접근합니다.

### 3. 설문조사 관리 흐름
1. 설문조사 생성:
   • 로그인한 사용자가 설문 제목, 설명, 옵션을 입력합니다.
   • 새 설문조사 레코드와 관련 옵션 레코드가 데이터베이스에 생성됩니다.
   • 고유한 공유 UUID가 생성되어 설문조사에 할당됩니다.

2. 설문조사 조회:
   • 사용자는 대시보드에서 자신이 생성한 설문조사 목록을 볼 수 있습니다.
   • 각 설문조사에 대한 응답 수와 상태(활성/비활성)가 표시됩니다.

3. 설문조사 응답:
   • 공유 링크를 통해 설문조사에 접근할 수 있습니다.
   • 응답자는 옵션을 선택하고 선택적으로 이메일을 입력할 수 있습니다.
   • 응답이 데이터베이스에 저장됩니다.

4. 결과 분석:
   • 설문 생성자는 각 옵션별 응답 수와 비율을 확인할 수 있습니다.
   • 응답자 목록과 선택한 옵션을 볼 수 있습니다.

### 4. 배포 및 실행 흐름
1. 개발 환경:
   • python run.py를 실행하여 Flask 내장 서버로 애플리케이션을 실행합니다.

2. 프로덕션 환경:
   • ./start.sh를 실행하여 Gunicorn으로 애플리케이션을 실행합니다.

3. 컨테이너 환경:
   • entrypoint.sh 스크립트가 실행됩니다.
   • 환경 변수를 설정하고 데이터베이스를 초기화합니다.
   • Gunicorn으로 애플리케이션을 실행합니다.

## 데이터 흐름 요약

1. 사용자 요청 → Flask 라우터가 요청을 적절한 뷰 함수로 전달
2. 뷰 함수 → 데이터베이스 모델과 상호작용하여 데이터 처리
3. 데이터 처리 결과 → 템플릿에 전달되어 HTML 렌더링
4. HTML 응답 → 사용자 브라우저에 전송

이 애플리케이션은 Flask의 애플리케이션 팩토리 패턴을 사용하여 모듈화되어 있으며, 블루프린트를 통해 기능별로 라우트를 구성하고, SQLAlchemy ORM을 사용하여 데이터베이스 작업을 추상화하고 있습니다. 또한 Flask-Login을 통해 사용자 인증을 관리하고, Gunicorn을 사용하여 프로덕션 환경에서 안정적으로 실행됩니다.

```

3. 추가적으로 특정 기능을 깊이 이해하고 싶다면 다음과 같이 입력합니다:

```
이 코드베이스에서 인증(authorization)이 어떻게 동작하는지에 대해 심층적이고 깊이 있는 설명을 제공해 주세요.
Go 레벨 500 수준으로 설명해 주세요.
설명에 대한 결과를 auth_desc.md 로 저장해 주세요.
```

📋 출력 예시:

```
고객 설문조사 웹 애플리케이션의 인증(Authorization) 시스템에 대한 심층 분석을 auth_desc.md 파일에 저장했습니다.

이 분석에서는 다음과 같은 주요 내용을 다루었습니다:

1. 인증(Authentication)과 인가(Authorization)의 개념적 구분
   • 인증: 사용자 신원 확인 과정
   • 인가: 인증된 사용자에게 특정 리소스에 대한 접근 권한 부여 과정

2. 인가 시스템의 아키텍처
   • 소유권 기반 접근 제어 모델 분석
   • 라우트 레벨과 뷰 함수 내부의 인가 결정 지점 설명

3. 인가 메커니즘 심층 분석
   • @login_required 데코레이터의 내부 작동 방식
   • 뷰 함수 내 소유권 기반 인가 로직 분석
   • 공유 리소스에 대한 인가 처리 방식

4. 인가 흐름 분석
   • 설문 조회, 수정, 응답 과정에서의 인가 흐름 다이어그램

5. 기술적 구현 상세
   • 데이터베이스 레벨 인가 제약
   • ORM 레벨 인가 제약
   • 인가 결정의 원자성

6. 보안 분석
   • 현재 인가 시스템의 강점
   • 잠재적 취약점
   • 인가 우회 시나리오

7. 개선 방안
   • 데코레이터 기반 인가
   • 역할 기반 접근 제어(RBAC)
   • 속성 기반 접근 제어(ABAC)

이 분석은 코드베이스의 인가 메커니즘을 깊이 있게 이해하고, 보안 관점에서 평가하며, 더 정교한 인가 시스템으로 발전시키기 위한 방향을 제시합니다.
```

4. 출력 내용을 확인하고, Amazon Q CLI가 어떤 방식으로 파일을 탐색하고 설명하는지 확인합니다.
5. 마지막으로 다음 명령어로 사용 중인 컨텍스트와 토큰 수를 확인해봅니다:

```
> /usage
```

대규모 코드베이스의 경우, 탐색 범위를 축소하지 않으면 Amazon Q CLI가 처리할 수 있는 토큰 한도를 초과할 수 있으므로 주의가 필요합니다.

***

### 🧪 Task 02 – ERD 및 UML 시퀀스 다이어그램 생성

코드베이스의 이해도를 높이기 위해 시각적인 다이어그램은 매우 유용합니다. Amazon Q CLI는 ERD 및 UML 시퀀스 다이어그램을 Markdown 기반으로 생성할 수 있습니다.

1. ERD(Entity Relationship Diagram)를 생성하려면 다음을 입력합니다:

```
이 애플리케이션의 데이터 모델에 대한 ERD(Entity Relationship Diagram)를 생성해 주세요.
“data-model.md”라는 새로운 마크다운 문서에 작성해 주세요.
```

2. UML 시퀀스 다이어그램을 생성하려면 다음 명령어를 사용합니다:

```
사용자 등록과 로그인 프로세스에 대한 UML 시퀀스 다이어그램을 생성해 주세요.
해당 다이어그램을 README.md 파일에 추가해 주세요.
```

VSCode 사용자라면 “Enhanced Markdown Viewer” 확장 기능을 사용해 Marmaid 다이어그램을 시각적으로 확인할 수 있습니다.

***

### Task 03 – 오픈소스 코드베이스 분석

Amazon Q CLI를 활용해 외부 오픈소스 코드도 분석할 수 있습니다.

1. 새로운 임시 디렉토리를 만들고 이동합니다:

```
mkdir ~/projects/qcli-oss
cd ~/projects/qcli-oss
```

2. Amazon Q CLI의 GitHub 리포지토리를 클론합니다:

```
git clone https://github.com/aws/amazon-q-developer-cli.git
cd amazon-q-developer-cli
```

3. Amazon Q CLI를 실행하고, 다음 프롬프트를 입력합니다:

```
코드를 검토하고 mcp.settings를 어떻게 구성해야 하는지 알려줄 수 있나요?
```

출력 예시:

```
{
  "mcpServers": {
    "myTool": {
      "command": "/usr/local/bin/my-mcp-tool",
      "args": ["--verbose"],
      "env": {
        "API_KEY": "your-api-key"
      },
      "timeout": 60000
    }
  }
}
```

***

### Task 04 – 도구 기능 분석하기

Amazon Q CLI에 포함된 qterm 도구가 무엇을 하는지 궁금했다면 다음 프롬프트를 입력해보세요:

```
코드베이스를 검토하고 qterm이 무엇을 하는지 설명해줘.
```

Amazon Q CLI가 qterm의 동작 방식 및 역할을 상세히 설명해줄 것입니다.

***

### 🧾 요약

이번 실습에서는 Amazon Q CLI를 활용하여 코드베이스를 이해하고, 구조 및 동작 원리를 문서화하는 과정을 수행했습니다. 다음 정리 작업을 진행해 주세요:

* qcli-app 프로젝트 디렉토리 삭제
* .aws/amazonq/mcp.json 등 설정 파일 정리

