---
description: 'Update : 2025.07.22'
---

# 13.네트워크 분석하기

***

## 🧩 Amazon Q CLI 기반 네트워크 운영 진단 랩

본 랩은 실제 운영 환경에서 발생 가능한 네트워크 문제를 Amazon Q CLI를 통해 진단하고, 실시간으로 문제 원인을 파악하여 해결책을 제시하는 실습입니다. 인프라 운영, 보안, SRE 관점의 다양한 케이스를 포함하고 있으며, 이미 배포된 AWS 환경을 기준으로 진행됩니다.

***

### 🧪 시나리오 목록

1. ✅ 네트워크 현황 분✅ TGW 연결 문제
2. ✅ NAT Gateway 성능 확인
3. ✅ Load Balancer 헬스체크 실패
4. ✅ 내부 DNS 해석 오류
5. ✅ 종합 네트워크 진단 (고급)

***

### 🧪 Step1:  Profile/Context 구성

✅  네트워크 운영자를 위한 Profile과 Context를 구성해 봅니다.

````
mkdir ~/projects
mkdir ~/projects/netops
mkdir ~/projects/netops/rules
cat > ~/projects/netops/rules/netops.md << 'EOF'
## Cloud Network Infrastructure Operations Specialist

## 1. 역할 및 전문성 정의 (Role & Expertise Definition)
당신은 12년 경력의 AWS 클라우드 네트워크 인프라 운영 전문가입니다.
- 대규모 멀티 VPC 환경 설계 및 운영 (50+ VPC)
- 하이브리드 클라우드 네트워크 연결 전문성 (Direct Connect, VPN)
- 네트워크 보안 및 트래픽 분석 전문가 (WAF, Shield, GuardDuty)
- 네트워크 자동화 및 Infrastructure as Code 전문가

## 2. 핵심 네트워크 영역별 대응 방식 (Core Network Areas)

### 2.1 VPC 및 연결성 관리
- CIDR 블록 계획: /16 VPC, /24 서브넷 표준
- IP 주소 사용률 모니터링 (80% 임계점)
- Transit Gateway, VPC Peering, Direct Connect 상태 관리
- VPN 터널 및 BGP 세션 안정성 확인

### 2.2 로드 밸런싱 및 트래픽 관리
- ALB/NLB 타겟 그룹 헬스 체크 상태
- Route 53 헬스 체크 및 페일오버 설정
- CloudFront 캐시 히트율 최적화 (목표: 85% 이상)
- 지역별 성능 모니터링 및 지연시간 최적화

### 2.3 네트워크 보안 관리
- 보안 그룹 최소 권한 원칙 적용
- VPC Flow Logs 트래픽 패턴 분석
- WAF & Shield DDoS 방어 설정
- 네트워크 ACL 및 보안 그룹 규칙 정기 검토

## 3. 핵심 성능 지표 및 알람 (KPIs & Alarms)

### 성능 메트릭
- 패킷 손실률 (목표: < 0.1%)
- 네트워크 지연시간 (목표: < 50ms 리전 내)
- 대역폭 사용률 (목표: < 80%)
- 연결 성공률 (목표: > 99.9%)

### Critical (P0) 알람
- Direct Connect 연결 끊김
- VPN 터널 모두 다운
- Load Balancer 타겟 모두 Unhealthy
- DNS 해석 실패율 > 5%

## 4. 트러블슈팅 가이드 (Troubleshooting Guide)

### 연결성 문제 진단 순서
1. 물리적 연결 확인 (Direct Connect, VPN 터널)
2. 라우팅 테이블 검증 (목적지 경로, BGP 라우팅)
3. 보안 설정 검토 (보안 그룹, NACL, WAF)
4. DNS 해석 확인 (Route 53, VPC DNS)

### 성능 최적화 체크리스트
1. Enhanced Networking 활성화
2. Placement Group 활용
3. CDN 캐시 전략 최적화
4. 로드 밸런서 알고리즘 조정

## 5. 응답 형식 (Response Format)
모든 네트워크 관련 답변은 다음 구조를 따름:
1. **🌐 네트워크 상태 분석** (연결성, 성능, 보안)
2. **📊 트래픽 패턴 분석** (Flow Logs, 메트릭 분석)
3. **🔧 즉시 조치사항** (단계별 실행 가이드)
4. **🛡️ 보안 영향 평가** (보안 그룹, WAF, Shield)
5. **⚡ 성능 최적화** (지연시간, 처리량, 가용성)
6. **💰 비용 최적화** (데이터 전송, 리소스 사용률)
7. **🤖 자동화 방안** (모니터링, 대응 자동화)

## 6. MCP 도구 활용 (MCP Tools)

### CloudWatch MCP
```bash
# 네트워크 성능 메트릭 조회
awslabscloudwatch_mcp_server___get_metric_data
# VPC Flow Logs 분석
awslabscloudwatch_mcp_server___execute_log_insights_query
```

### AWS API MCP
```bash
# VPC 상태 조회
use_aws ec2 describe-vpcs
# 보안 그룹 검토
use_aws ec2 describe-security-groups
# Load Balancer 상태
use_aws elbv2 describe-load-balancers
```

## 7. 주요 시나리오별 대응 (Key Scenarios)

### Direct Connect 장애
1. 물리적 포트 및 BGP 세션 확인
2. VPN 백업 연결 자동 활성화
3. 트래픽 우회 경로 성능 평가
4. ISP 협력 및 복구 계획 수립

### DDoS 공격
1. CloudWatch 및 WAF 로그 분석
2. Shield Advanced 및 WAF 규칙 활성화
3. CloudFront 및 Route 53 트래픽 우회
4. 공격 벡터 분석 및 방어 강화

### 네트워크 성능 저하
1. Flow Logs 및 메트릭으로 병목 식별
2. 라우팅 최적화 및 로드 밸런싱
3. 대역폭 증설 또는 인스턴스 업그레이드
4. 아키텍처 개선 및 CDN 활용

## 8. 비용 최적화 전략 (Cost Optimization)
- CloudFront 캐시 히트율 향상으로 Origin 트래픽 감소
- NAT Gateway 대신 VPC Endpoint 활용
- Direct Connect로 대용량 데이터 전송 비용 절감
- 미사용 Elastic IP 정리

## 9. 보안 베스트 프랙티스 (Security Best Practices)
- 최소 권한 원칙: 필요한 포트/프로토콜만 허용
- 마이크로 세그멘테이션: 서비스별 보안 그룹 분리
- 지속적 검증: 정기적 보안 감사 및 규칙 검토
- 전송 중/저장 중 데이터 암호화

## 10. 고가용성 설계 (High Availability)
- 다중 가용 영역 (최소 3개 AZ)
- Direct Connect + VPN 백업 연결
- Route 53 헬스 체크 기반 자동 페일오버
- RTO 목표: 15분 이내 네트워크 서비스 복구

## 주의사항 (Important Notes)
- 피크 트래픽 대비 150% 용량 확보
- CloudWatch 메트릭 5분 지연 고려
- 데이터 전송 비용 일일 추적
- 네트워크 다이어그램 및 설정 문서 최신 유지
EOF
````

✅ Amazon Q Chat에서 Profile과 Context 구성하기:

network 운영자를 위한 프로파일을 생성합니다.

```bash
/profile create netops
```

앞서 생성한 EC2 운영자를 위한 context를 ec2ops 프로파일에 연결 구성합니다.

```
/context add ~/projects/netops/rules/netops.md
```

아래 명령을 통해서 정상적으로 context가 입력되었는지 확인합니다.

```
/context show
```

출력 예시:

```
[ec2ops] > /context show


🌍 global:
[netops] > /context show


🌍 global:
    .amazonq/rules/**/*.md (1 match)
    README.md 
    AmazonQ.md 

👤 profile (netops):
    ~/projects/netops/rules/netops.md (1 match)

2 matched files in use:
🌍 /home/ec2-user/.amazonq/rules/AmazonQ.md (~720 tkns)
👤 /home/ec2-user/projects/netops/rules/netops.md (~1200 tkns)

Total: ~1920 tokens

```

### 🧪 Step2: 현재 라우팅 테이블 상세 분석하기 

🎯 목표: 현재 네트워크를 상세하게 분석하기\


🧪 실습 단계:

💬 프롬프트 예시:

```
"현재 계정의 네트워크 구성을 상세하게 분석해줘"
결과는 ~/projects/netops/ 에 markdown으로 저장해줘.
steampipe를 활용해줘.
```

출력 예시

```
# 1단계: 네트워크 구성 분석
q chat "EC2 인스턴스 i-1234567890abcdef0의 네트워크 구성을 분석해줘"

# 2단계: 보안 그룹 확인
q chat "이 인스턴스의 보안 그룹 규칙을 확인하고 웹 트래픽(80, 443 포트) 허용 여부를 분석해줘"

# 3단계: 라우팅 테이블 확인
q chat "해당 서브넷의 라우팅 테이블을 확인하고 IGW 연결 상태를 점검해줘"

# 4단계: NACL 확인
q chat "네트워크 ACL 설정을 확인하고 트래픽 차단 여부를 분석해줘"
```

✅ 기대 결과:

* 허용되지 않은 보안 그룹 또는 NACL 룰 확인
* 올바르지 않은 라우팅 설정 탐지
* 해결 방안과 수정 명령 안내

***

### 🧪 시나리오 2: TGW 연결 문제 

🎯 목표: TGW Routing 문제 확인하기.\


🔧 상황:

* VPC A: 10.0.0.0/16
* VPC B: 172.16.0.0/16
* 피어링 ID: pcx-1234567890abcdef0

\


🧪 실습 단계:

```
# 1단계: Peering 연결 상태
q chat "VPC Peering 연결 pcx-1234567890abcdef0의 상태와 구성을 분석해줘"

# 2단계: 라우팅 설정 확인
q chat "양쪽 VPC의 라우팅 테이블에서 피어링 경로가 올바르게 설정되어 있는지 확인해줘"

# 3단계: CIDR 충돌 여부
q chat "두 VPC 간 CIDR 블록 충돌이 있는지 확인하고, 겹치는 IP 대역이 있다면 해결 방안을 제시해줘"
```

✅ 기대 결과: 피어링 불가 원인 확인 및 수정 제안 (경로 누락, CIDR 충돌 등)

***

### 🧪 시나리오 3: NAT Gateway 성능 문제

\


🎯 목표: 프라이빗 서브넷에서의 외부 통신 지연 원인을 성능 메트릭으로 분석

\


🔧 상황:

* NAT Gateway ID: nat-1234567890abcdef0
* EC2 인스턴스들이 외부로 느리게 나감

\


🧪 실습 단계:

```
# 1단계: CloudWatch 메트릭 확인
q chat "NAT Gateway nat-1234567890abcdef0의 CloudWatch 메트릭을 분석하고 병목 원인을 알려줘"

# 2단계: 대역폭 분석
q chat "지난 24시간 동안의 NAT Gateway 대역폭 사용 패턴을 분석해줘"

# 3단계: 비용 최적화
q chat "현재 NAT Gateway 사용량을 기반으로 비용 최적화 방안을 제안해줘"
```

✅ 기대 결과: Throughput/Connection 수 기반 성능 이슈 파악 및 Multi-AZ 배포 또는 Split NAT 전략 제안

***

### 🧪 시나리오 4: Load Balancer 헬스체크 실패

\


🎯 목표: ALB 타겟 인스턴스의 Unhealthy 상태 원인 분석

\


🔧 상황:

* ALB ARN: arn:aws:elasticloadbalancing:region:account:loadbalancer/app/my-alb/...

\


🧪 실습 단계:

```
# 1단계: 타겟 그룹 상태 확인
q chat "ALB의 타겟 그룹 상태를 확인하고 Unhealthy 타겟들의 원인을 분석해줘"

# 2단계: 헬스체크 설정 검토
q chat "헬스체크 경로, 포트, 프로토콜 설정이 올바른지 확인해줘"

# 3단계: 보안 그룹 트래픽 확인
q chat "ALB와 타겟 인스턴스 간 보안 그룹 설정을 점검해줘"
```

✅ 기대 결과: HTTP 응답 오류, 포트 비일치, 보안 그룹 차단 등 정확한 원인 확인

***

### 🧪 시나리오 5: DNS 해석 문제

\


🎯 목표: 내부 DNS 도메인(example.internal) 해석 불가 원인 분석

\


🔧 상황:

* Route 53 Private Hosted Zone: example.internal

\


🧪 실습 단계:

```
# 1단계: Hosted Zone 설정 확인
q chat "Route 53 프라이빗 호스팅 존의 DNS 레코드와 VPC 연결 설정을 확인해줘"

# 2단계: VPC DNS 설정 확인
q chat "VPC의 DNS 해석 및 DNS 호스트네임 설정이 활성화되어 있는지 확인해줘"

# 3단계: DHCP 옵션 확인
q chat "VPC의 DHCP 옵션 세트 구성을 점검해줘"
```

✅ 기대 결과: DNS 호스트네임/해석 옵션 비활성, DHCP 옵션 누락 등 문제 확인

***

### 🧪 시나리오 6: VPN 연결 문제

\


🎯 목표: Site-to-Site VPN 연결 불안정 원인 확인

\


🔧 상황:

* VPN Connection ID: vpn-1234567890abcdef0

\


🧪 실습 단계:

```
# 1단계: 터널 상태 확인
q chat "VPN 연결의 터널 상태와 BGP 세션 정보를 분석해줘"

# 2단계: 경로 전파 상태 확인
q chat "VPN을 통한 라우팅 전파가 작동하는지 분석해줘"

# 3단계: 암호화 설정 확인
q chat "VPN 터널의 암호화 설정 및 보안 정책 일치 여부를 확인해줘"
```

✅ 기대 결과: 터널 다운, BGP 비활성, Phase1/2 설정 불일치 등 분석

***

### 🧪 고급 시나리오: 종합 네트워크 진단

\


🎯 목표: 복합적인 아키텍처에서 간헐적 지연 및 타임아웃 발생 원인을 포괄적으로 분석

\


🔧 상황:

* 3-tier 구조 (Web/App/DB)
* Multi-AZ, Auto Scaling, ALB, RDS Multi-AZ 구성

\


🧪 진단 요청 예시:

```
q chat "다음 환경에서 네트워크 연결 문제를 종합적으로 진단해줘:
- 3-tier 아키텍처 (Web/App/DB)
- Multi-AZ 배포
- Auto Scaling 그룹
- Application Load Balancer
- RDS Multi-AZ
현재 증상: 간헐적인 응답 지연 및 타임아웃"
```

✅ 기대 결과:

* AZ 간 지연, Health Check 실패, Connection Timeout, 과도한 NAT 부하 등 종합 분석

***

이 실습 문서는 GitBook 형태로 바로 사용 가능하며, 각 시나리오별로 실습 단계와 명령어가 구체화되어 있습니다.

필요 시 .md 또는 .gitbook.yaml 형태로도 내보내 드릴 수 있습니다.

\


추가로 Steampipe 기반 시큐리티 분석 시나리오도 연동하시겠습니까?
